<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåŒ–è§†å£é€‚é…ï¼šå¢åŠ çŠ¶æ€æ /åº•éƒ¨å®‰å…¨åŒºé€‚é… -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- é€‚é…å®‰å“/iOSçŠ¶æ€æ æ ·å¼ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="#f5f5f5">
    <meta name="theme-color" content="#f5f5f5">
    <title>ä¼˜æƒ åˆ¸ç®¡ç†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å…¨å±€ç¦ç”¨å®‰å“WebViewé»˜è®¤ç‚¹å‡»é«˜äº®ï¼ˆæ ¸å¿ƒï¼šè§£å†³æ–¹å½¢èƒŒæ™¯ï¼‰ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç¦ç”¨ç‚¹å‡»é«˜äº® */
            tap-highlight-color: transparent;
            outline: none; /* ç§»é™¤ç„¦ç‚¹è½®å»“ */
        }

        body {
            -webkit-touch-callout: none; /* ç¦ç”¨é•¿æŒ‰èœå• */
            -webkit-user-select: none; /* ç¦ç”¨æ–‡æœ¬é€‰æ‹© */
            /* ç»Ÿä¸€bodyèƒŒæ™¯è‰²ä¸APPä¸»èƒŒæ™¯è‰²ï¼ŒåŒ¹é…çŠ¶æ€æ  */
            background-color: #f5f5f5;
            /* é¿å…å†…å®¹è¢«çŠ¶æ€æ è¦†ç›– */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
        }

        .phone-container {
            max-width: 402px;
            margin: 0 auto;
            border: none;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            position: relative;
            background-color: #f5f5f5; /* ç»Ÿä¸€å®¹å™¨èƒŒæ™¯è‰² */
            min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            height: 100%;
        }

        .top-bar {
            /* é€‚é…çŠ¶æ€æ é«˜åº¦ï¼štopå€¼å¢åŠ å®‰å…¨åŒºé«˜åº¦ */
            position: absolute;
            top: calc(15px + env(safe-area-inset-top));
            left: 0;
            width: 100%;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            /* é¡¶éƒ¨æ èƒŒæ™¯è‰²ï¼Œä¸çŠ¶æ€æ /APPèƒŒæ™¯ç»Ÿä¸€ */
            background-color: #f5f5f5;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .floating-tabs {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 6px;
        }

        /* ä¿®å¤æ ‡ç­¾æŒ‰é’®ç‚¹å‡»æ–¹å½¢èƒŒæ™¯ï¼šç§»é™¤box-shadowã€ç®€åŒ–æ ·å¼ */
        .tab-item {
            padding: 8px 0;
            background-color: #fff;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s; /* ä»…ä¿ç•™å¿…è¦è¿‡æ¸¡ */
            border: none;
            outline: none;
            text-align: center;
            line-height: 1;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none; /* ç¦ç”¨åŸç”Ÿæ ·å¼ */
            appearance: none;
        }

        .tab-item.active {
            color: #fff;
            background-color: #2f80ed;
        }

        /* ç§»é™¤tab-itemç‚¹å‡»çš„æ‰€æœ‰é«˜äº®æ ·å¼ */
        .tab-item:active, .tab-item:focus {
            box-shadow: none; /* ç§»é™¤ç‚¹å‡»é˜´å½± */
            outline: none;
        }

        .add-coupon-btn {
            width: 36px;
            height: 36px;
            color: #2f80ed;
            font-size: 28px;
            border: none;
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            -webkit-appearance: none;
            appearance: none;
        }

        .add-coupon-btn:active {
            color: #1e6fcf;
            transform: scale(1.1);
        }

        .coupon-app {
            /* è°ƒæ•´é¡¶éƒ¨å†…è¾¹è·ï¼šé€‚é…çŠ¶æ€æ +é¡¶éƒ¨æ é«˜åº¦ */
            padding-top: calc(80px + env(safe-area-inset-top));
            /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼šé€‚é…åº•éƒ¨å®‰å…¨åŒºï¼Œé¿å…å†…å®¹è¢«é®æŒ¡ */
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            background-color: #f5f5f5;
            /* å›ºå®šé«˜åº¦ä¸ºè§†å£é«˜åº¦ï¼Œå‡å»é¡¶éƒ¨/åº•éƒ¨å®‰å…¨åŒº */
            min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            height: 100%;
            width: 100%;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr;
            overflow: hidden;
            /* å†…å®¹åŒºåŸŸé«˜åº¦é“ºæ»¡å‰©ä½™ç©ºé—´ */
            height: 100%;
            padding: 0 10px;
        }

        .coupon-list {
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            /* é‡æ–°è®¡ç®—æ»šåŠ¨åŒºåŸŸé«˜åº¦ï¼š100% - ä¸Šä¸‹å†…è¾¹è·ï¼Œç¡®ä¿å¯æ»šåŠ¨ */
            height: 100%;
            scrollbar-width: none;
            /* åº•éƒ¨é¢å¤–å†…è¾¹è·ï¼Œæœ€åä¸€é¡¹ä¸è¢«é®æŒ¡ */
            padding-bottom: 20px;
        }
        .coupon-list::-webkit-scrollbar {
            display: none;
        }

        /* æ ‡ç­¾æ˜¾ç¤ºæ§åˆ¶ */
        .unused-list { display: block; }
        .used-list { display: none; }
        .recycle-list { display: none; }

        /* åˆ†ç±»å®¹å™¨æ ·å¼ */
        .category-group {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .category-header {
            padding: 12px 15px;
            background-color: #f8fbff;
            border-bottom: 1px solid #f0f7ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-icon {
            color: #2f80ed;
            font-size: 16px;
        }

        .category-name {
            font-size: 15px;
            font-weight: 600;
            color: #2f80ed;
        }

        .category-coupons {
            padding: 5px;
        }

        /* ä¼˜æƒ åˆ¸é¡¹æ ·å¼ */
        .coupon-item {
            padding: 10px 15px;
            display: grid;
            gap: 8px;
            align-items: center;
            width: 100%;
            margin-bottom: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
            transition: all 0.3s ease;
            opacity: 1;
            height: auto;
            overflow: hidden;
            touch-action: manipulation;
        }

        .coupon-item.deleting {
            opacity: 0;
            height: 0;
            margin-bottom: 0;
            padding: 0 15px;
            transition: all 0.3s ease;
        }

        .coupon-item:active {
            background-color: #f8f8f8;
        }

        /* æœªä½¿ç”¨ä¼˜æƒ åˆ¸å¸ƒå±€ */
        .unused-list .coupon-item {
            grid-template-columns: auto 1fr auto auto;
        }

        /* å·²ä½¿ç”¨/å›æ”¶ç«™å¸ƒå±€ */
        .used-list .coupon-item,
        .recycle-list .coupon-item {
            grid-template-columns: 1fr auto;
        }

        .checkbox-wrapper {
            width: 24px;
            height: 24px;
            position: relative;
        }

        .coupon-checkbox {
            width: 100%;
            height: 100%;
            cursor: pointer;
            accent-color: #2f80ed;
            -webkit-appearance: none;
            appearance: none;
        }

        .coupon-content {
            display: grid;
            gap: 6px;
        }

        .coupon-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            line-height: 1.3;
        }

        .coupon-expire {
            font-size: 12px;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* å·²ä½¿ç”¨-ä½¿ç”¨æ—¶é—´ */
        .coupon-use-time {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* å›æ”¶ç«™-åˆ é™¤æ—¶é—´ */
        .coupon-delete-time {
            font-size: 12px;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .coupon-note {
            font-size: 12px;
            color: #999;
            line-height: 1.4;
        }

        /* å·²ä½¿ç”¨/å›æ”¶ç«™æ–‡å­—æ ·å¼ */
        .used-list .coupon-title,
        .recycle-list .coupon-title {
            color: #999;
            text-decoration: line-through;
        }

        .used-list .coupon-expire,
        .recycle-list .coupon-expire {
            color: #999;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            pointer-events: auto;
            z-index: 999;
            transform: scale(1);
            -webkit-appearance: none;
            appearance: none;
        }

        .action-btn:active {
            transform: scale(0.9);
            opacity: 0.8;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        .edit-btn { background-color: #f0f7ff; color: #2f80ed; }
        .edit-btn:active { background-color: #e8f3ff; transform: scale(1.1); }
        .delete-btn { background-color: #fff0f0; color: #ff6b6b; }
        .delete-btn:active { background-color: #ffe8e8; transform: scale(1.1); }
        .restore-btn { background-color: #f0fff4; color: #4caf50; }
        .restore-btn:active { background-color: #e8f5e9; transform: scale(1.1); }
        .remove-btn { background-color: #ffebee; color: #f44336; }
        .remove-btn:active { background-color: #ffcdd2; transform: scale(1.1); }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-tip {
            text-align: center;
            padding: 40px 0;
            color: #ccc;
            font-size: 14px;
            width: 100%;
            margin-top: 50%;
            transform: translateY(-50%);
        }

        .empty-tip i {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
            color: #ddd;
        }

        /* ========== å¼¹çª—å±…ä¸­æ ·å¼ï¼šæ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† ========== */
        /* åŸºç¡€å¼¹çª—æ ·å¼ï¼šå±…ä¸­æ˜¾ç¤º + é«˜å±‚çº§é¿å…é®æŒ¡ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000; /* è¿œé«˜äºæŒ‰é’®çš„z-index:10 */
            display: none;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            padding-top: 0; /* ç§»é™¤é¡¶éƒ¨å†…è¾¹è·ï¼Œç¡®ä¿å±…ä¸­ */
            /* é€‚é…å®‰å…¨åŒºï¼Œå¼¹çª—ä¸è¢«çŠ¶æ€æ /åº•éƒ¨æ é®æŒ¡ */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .modal-content {
            background-color: #fff;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        /* ç¡®è®¤åˆ é™¤å¼¹çª—ï¼šåŒæ ·å±…ä¸­æ˜¾ç¤º */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000; /* æœ€é«˜å±‚çº§ */
            display: none;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            padding-top: 0; /* ç§»é™¤é¡¶éƒ¨å†…è¾¹è·ï¼Œç¡®ä¿å±…ä¸­ */
            /* é€‚é…å®‰å…¨åŒºï¼Œå¼¹çª—ä¸è¢«çŠ¶æ€æ /åº•éƒ¨æ é®æŒ¡ */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .confirm-content {
            background-color: #fff;
            border-radius: 16px;
            padding: 24px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .confirm-icon {
            font-size: 32px;
            color: #ff6b6b;
            margin-bottom: 16px;
        }

        .confirm-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .confirm-cancel, .confirm-delete {
            padding: 10px 0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .confirm-cancel {
            border: 1px solid #e0e0e0;
            background-color: #fff;
            color: #666;
        }

        .confirm-delete {
            background-color: #ff6b6b;
            color: #fff;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 14px; color: #666; margin-bottom: 6px; display: block; }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .form-input:focus { border-color: #2f80ed; }

        .modal-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .cancel-btn { background-color: #f5f5f5; color: #666; }
        .confirm-btn { background-color: #2f80ed; color: #fff; }

        /* Toast æç¤ºæ ·å¼ï¼šé€‚é…åº•éƒ¨å®‰å…¨åŒº */
        .toast {
            position: fixed;
            bottom: calc(30px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001; /* é«˜äºå¼¹çª— */
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ç§»åŠ¨ç«¯é€‚é…å¼ºåŒ– */
        @media (max-width: 480px) {
            .phone-container { 
                margin:0; 
                border:none; 
                border-radius:0; 
                height:100%;
                min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            .top-bar { 
                top: calc(15px + env(safe-area-inset-top));
                padding: 5px 15px; 
            }
            .floating-tabs { grid-template-columns: repeat(3, 70px); gap: 6px; }
            .tab-item { padding: 8px 0; font-size: 13px; height: 36px; }
            .add-coupon-btn { width: 36px; height: 36px; font-size: 28px; }
            .coupon-app { 
                padding-top: calc(80px + env(safe-area-inset-top)); 
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            .coupon-list { 
                height: 100%;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            .action-btn { width: 32px; height: 32px; font-size: 14px; }
            
            /* å¼¹çª—åœ¨å°å±æ‰‹æœºä¸Šä¿æŒå±…ä¸­ */
            .modal, .confirm-modal {
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="top-bar">
            <div class="floating-tabs">
                <button class="tab-item active" id="unused-tab">æœªä½¿ç”¨</button>
                <button class="tab-item" id="used-tab">å·²ä½¿ç”¨</button>
                <button class="tab-item" id="recycle-tab">å›æ”¶ç«™</button>
            </div>
            <button class="add-coupon-btn" id="add-coupon-btn">+</button>
        </div>

        <div class="coupon-app">
            <div class="content-area">
                <!-- æœªä½¿ç”¨åˆ—è¡¨ -->
                <div class="coupon-list unused-list" id="unused-list">
                    <div class="empty-tip" id="unused-empty">
                        <i class="fas fa-ticket-alt"></i><p>æš‚æ— ä¼˜æƒ åˆ¸</p>
                    </div>
                </div>

                <!-- å·²ä½¿ç”¨åˆ—è¡¨ -->
                <div class="coupon-list used-list" id="used-list">
                    <div class="empty-tip" id="used-empty">
                        <i class="fas fa-check-circle"></i><p>æš‚æ— å·²ä½¿ç”¨çš„ä¼˜æƒ åˆ¸</p>
                    </div>
                </div>

                <!-- å›æ”¶ç«™åˆ—è¡¨ -->
                <div class="coupon-list recycle-list" id="recycle-list">
                    <div class="empty-tip" id="recycle-empty">
                        <i class="fas fa-trash-alt"></i><p>æš‚æ— å·²åˆ é™¤çš„ä¼˜æƒ åˆ¸</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å¼¹çª— -->
    <div class="modal" id="add-modal">
        <div class="modal-content">
            <h3 class="modal-title">æ–°å¢ä¼˜æƒ åˆ¸</h3>
            <div class="form-group">
                <label class="form-label">åˆ†ç±»</label>
                <input type="text" class="form-input" id="add-category" placeholder="ä¾‹å¦‚ï¼šç”µå•†ã€é¤é¥®">
            </div>
            <div class="form-group">
                <label class="form-label">æ ‡é¢˜</label>
                <input type="text" class="form-input" id="add-title" placeholder="ä¾‹å¦‚ï¼šäº¬ä¸œæ»¡200å‡50ä¼˜æƒ åˆ¸">
            </div>
            <div class="form-group">
                <label class="form-label">åˆ°æœŸæ—¶é—´</label>
                <input type="text" class="form-input" id="add-expire" placeholder="ä¾‹å¦‚ï¼š2026-05-30">
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <input type="text" class="form-input" id="add-note" placeholder="ä¾‹å¦‚ï¼šé™å®¶ç”µå“ç±»ä½¿ç”¨">
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel-btn" id="cancel-add">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirm-add">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <h3 class="modal-title">ç¼–è¾‘ä¼˜æƒ åˆ¸</h3>
            <div class="form-group">
                <label class="form-label">åˆ†ç±»</label>
                <input type="text" class="form-input" id="edit-category">
            </div>
            <div class="form-group">
                <label class="form-label">æ ‡é¢˜</label>
                <input type="text" class="form-input" id="edit-title">
            </div>
            <div class="form-group">
                <label class="form-label">åˆ°æœŸæ—¶é—´</label>
                <input type="text" class="form-input" id="edit-expire">
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <input type="text" class="form-input" id="edit-note">
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel-btn" id="cancel-edit">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirm-edit">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
    <div class="confirm-modal" id="delete-confirm-modal">
        <div class="confirm-content">
            <i class="fas fa-exclamation-circle confirm-icon"></i>
            <p class="confirm-text">ç¡®å®šå½»åº•åˆ é™¤è¯¥ä¼˜æƒ åˆ¸ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
            <div class="confirm-btns">
                <button class="confirm-cancel" id="confirm-cancel-btn">å–æ¶ˆ</button>
                <button class="confirm-delete" id="confirm-delete-btn">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== æ ¸å¿ƒä¼˜åŒ–ï¼šå…¼å®¹å®‰å“WebViewçš„æœ¬åœ°å­˜å‚¨å‡½æ•° ==========
        function isLocalStorageAvailable() {
            try {
                const testKey = 'coupon_test_key';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        }

        function loadFromStorage() {
            if (!isLocalStorageAvailable()) {
                showToast('âš ï¸ æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼Œæ•°æ®æ— æ³•ä¿å­˜ï¼');
                couponData = {};
                recycleData = {};
                maxCouponId = 0;
                couponOrder = [];
                recycleOrder = [];
                return;
            }

            try {
                const savedCouponData = localStorage.getItem('couponData') || '{}';
                const savedRecycleData = localStorage.getItem('recycleData') || '{}';
                const savedMaxCouponId = localStorage.getItem('maxCouponId') || '0';
                const savedCouponOrder = localStorage.getItem('couponOrder') || '[]';
                const savedRecycleOrder = localStorage.getItem('recycleOrder') || '[]';

                couponData = JSON.parse(savedCouponData) || {};
                recycleData = JSON.parse(savedRecycleData) || {};
                maxCouponId = parseInt(savedMaxCouponId) || 0;
                couponOrder = JSON.parse(savedCouponOrder) || [];
                recycleOrder = JSON.parse(savedRecycleOrder) || [];
                
                showToast('âœ… å·²åŠ è½½å†å²æ•°æ®');
            } catch (e) {
                showToast('âš ï¸ åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®ï¼');
                couponData = {};
                recycleData = {};
                maxCouponId = 0;
                couponOrder = [];
                recycleOrder = [];
            }
        }

        function saveToStorage() {
            if (!isLocalStorageAvailable()) {
                showToast('âš ï¸ æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼Œæ•°æ®æ— æ³•ä¿å­˜ï¼');
                return;
            }

            try {
                setTimeout(() => {
                    localStorage.setItem('couponData', JSON.stringify(couponData));
                    localStorage.setItem('recycleData', JSON.stringify(recycleData));
                    localStorage.setItem('maxCouponId', maxCouponId.toString());
                    localStorage.setItem('couponOrder', JSON.stringify(couponOrder));
                    localStorage.setItem('recycleOrder', JSON.stringify(recycleOrder));
                    
                    const verify = localStorage.getItem('couponData');
                    if (verify) showToast('âœ… æ•°æ®å·²ä¿å­˜');
                }, 100);
            } catch (e) {
                showToast('âš ï¸ ä¿å­˜æ•°æ®å¤±è´¥ï¼');
            }
        }

        // ========== æ•°æ®å®šä¹‰ ==========
        let couponData = {};       
        let recycleData = {};      
        let maxCouponId = 0;
        let couponOrder = [];      
        let recycleOrder = [];     
        let currentDeleteId = null;
        let currentEditId = null;

        // ========== DOMå…ƒç´ è·å– ==========
        const unusedList = document.getElementById('unused-list');
        const usedList = document.getElementById('used-list');
        const recycleList = document.getElementById('recycle-list');
        const unusedEmpty = document.getElementById('unused-empty');
        const usedEmpty = document.getElementById('used-empty');
        const recycleEmpty = document.getElementById('recycle-empty');
        const addCouponBtn = document.getElementById('add-coupon-btn');
        const addModal = document.getElementById('add-modal');
        const editModal = document.getElementById('edit-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const toast = document.getElementById('toast');

        // ========== å·¥å…·å‡½æ•° ==========
        function getCurrentTime() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            const hh = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        function getCategoryIcon(cat) {
            const map = {
                'ç”µå•†':'fa-shopping-cart','é¤é¥®':'fa-coffee','å‡ºè¡Œ':'fa-gas-pump','é…’åº—':'fa-hotel'
            };
            return map[cat] || 'fa-tag';
        }

        function checkEmptyState() {
            const unusedCount = Object.keys(couponData).filter(id => !couponData[id].isUsed).length;
            const usedCount = Object.keys(couponData).filter(id => couponData[id].isUsed).length;
            const recycleCount = Object.keys(recycleData).length;
            
            unusedEmpty.style.display = unusedCount > 0 ? 'none' : 'block';
            usedEmpty.style.display = usedCount > 0 ? 'none' : 'block';
            recycleEmpty.style.display = recycleCount > 0 ? 'none' : 'block';
        }

        function showToast(message, duration = 2000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // ========== æ¸²æŸ“å‡½æ•° ==========
        function renderCoupon(id) {
            const d = couponData[id];
            const el = document.createElement('div');
            el.className = 'coupon-item';
            el.dataset.id = id;

            if (!d.isUsed) {
                el.innerHTML = `
                    <div class="checkbox-wrapper"><input type="checkbox" class="coupon-checkbox"></div>
                    <div class="coupon-content">
                        <div class="coupon-title">${d.title}</div>
                        <div class="coupon-expire"><i class="fas fa-clock"></i> åˆ°æœŸæ—¶é—´ï¼š${d.expire}</div>
                        <div class="coupon-note">${d.note || 'æ— å¤‡æ³¨'}</div>
                    </div>
                    <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                `;
            } else {
                el.innerHTML = `
                    <div class="coupon-content">
                        <div class="coupon-title">${d.title}</div>
                        <div class="coupon-expire"><i class="fas fa-clock"></i> åˆ°æœŸæ—¶é—´ï¼š${d.expire}</div>
                        <div class="coupon-use-time"><i class="fas fa-calendar-check"></i> ä½¿ç”¨æ—¶é—´ï¼š${d.useTime}</div>
                        <div class="coupon-note">${d.note || 'æ— å¤‡æ³¨'}</div>
                    </div>
                    <button class="action-btn restore-btn" data-id="${id}"><i class="fas fa-undo"></i></button>
                `;
            }
            return el;
        }

        function renderRecycleCoupon(id) {
            const d = recycleData[id];
            const el = document.createElement('div');
            el.className = 'coupon-item';
            el.dataset.id = id;

            el.innerHTML = `
                <div class="coupon-content">
                    <div class="coupon-title">${d.title}</div>
                    <div class="coupon-expire"><i class="fas fa-clock"></i> åˆ°æœŸæ—¶é—´ï¼š${d.expire}</div>
                    <div class="coupon-delete-time"><i class="fas fa-trash-alt"></i> åˆ é™¤æ—¶é—´ï¼š${d.deleteTime}</div>
                    <div class="coupon-note">${d.note || 'æ— å¤‡æ³¨'}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="action-btn restore-btn" data-id="${id}"><i class="fas fa-undo"></i></button>
                    <button class="action-btn remove-btn" data-id="${id}"><i class="fas fa-times"></i></button>
                </div>
            `;
            return el;
        }

        function renderCategoryGroup(category, ids, isUsed = false) {
            const group = document.createElement('div');
            group.className = 'category-group';
            group.dataset.category = category;

            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <i class="fas ${getCategoryIcon(category)} category-icon"></i>
                <span class="category-name">${category}</span>
            `;
            group.appendChild(header);

            const couponsContainer = document.createElement('div');
            couponsContainer.className = 'category-coupons';
            
            const sortedIds = couponOrder.filter(id => ids.includes(id));
            sortedIds.forEach(id => {
                couponsContainer.appendChild(renderCoupon(id));
            });
            
            group.appendChild(couponsContainer);
            return group;
        }

        function renderRecycleCategoryGroup(category, ids) {
            const group = document.createElement('div');
            group.className = 'category-group';
            group.dataset.category = category;

            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <i class="fas ${getCategoryIcon(category)} category-icon"></i>
                <span class="category-name">${category}</span>
            `;
            group.appendChild(header);

            const couponsContainer = document.createElement('div');
            couponsContainer.className = 'category-coupons';
            
            const sortedIds = recycleOrder.filter(id => ids.includes(id));
            sortedIds.forEach(id => {
                couponsContainer.appendChild(renderRecycleCoupon(id));
            });
            
            group.appendChild(couponsContainer);
            return group;
        }

        function renderAll() {
            unusedList.innerHTML = '';
            usedList.innerHTML = '';
            recycleList.innerHTML = '';
            unusedList.appendChild(unusedEmpty);
            usedList.appendChild(usedEmpty);
            recycleList.appendChild(recycleEmpty);

            // æ¸²æŸ“æœªä½¿ç”¨åˆ—è¡¨
            const unusedIds = Object.keys(couponData).filter(id => !couponData[id].isUsed);
            const unusedCategories = {};
            unusedIds.forEach(id => {
                const category = couponData[id].category;
                if (!unusedCategories[category]) {
                    unusedCategories[category] = [];
                }
                unusedCategories[category].push(id);
            });
            Object.keys(unusedCategories).forEach(category => {
                const ids = unusedCategories[category];
                const categoryGroup = renderCategoryGroup(category, ids);
                unusedList.insertBefore(categoryGroup, unusedEmpty);
            });

            // æ¸²æŸ“å·²ä½¿ç”¨åˆ—è¡¨
            const usedIds = Object.keys(couponData).filter(id => couponData[id].isUsed);
            const usedCategories = {};
            usedIds.forEach(id => {
                const category = couponData[id].category;
                if (!usedCategories[category]) {
                    usedCategories[category] = [];
                }
                usedCategories[category].push(id);
            });
            Object.keys(usedCategories).forEach(category => {
                const ids = usedCategories[category];
                const categoryGroup = renderCategoryGroup(category, ids, true);
                usedList.insertBefore(categoryGroup, usedEmpty);
            });

            // æ¸²æŸ“å›æ”¶ç«™åˆ—è¡¨
            const recycleIds = Object.keys(recycleData);
            const recycleCategories = {};
            recycleIds.forEach(id => {
                const category = recycleData[id].category;
                if (!recycleCategories[category]) {
                    recycleCategories[category] = [];
                }
                recycleCategories[category].push(id);
            });
            Object.keys(recycleCategories).forEach(category => {
                const ids = recycleCategories[category];
                const categoryGroup = renderRecycleCategoryGroup(category, ids);
                recycleList.insertBefore(categoryGroup, recycleEmpty);
            });

            checkEmptyState();
            bindRecycleButtons();
        }

        function bindRecycleButtons() {
            // å›æ”¶ç«™æ¢å¤æŒ‰é’®
            document.querySelectorAll('.recycle-list .restore-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const couponId = this.dataset.id;
                    if (!couponId || !recycleData[couponId]) return;
                    
                    const recoveredCoupon = recycleData[couponId];
                    couponData[couponId] = {
                        category: recoveredCoupon.category,
                        title: recoveredCoupon.title,
                        expire: recoveredCoupon.expire,
                        note: recoveredCoupon.note,
                        isUsed: false,
                        useTime: ''
                    };
                    
                    if (!couponOrder.includes(couponId)) {
                        couponOrder.push(couponId);
                    }
                    delete recycleData[couponId];
                    recycleOrder = recycleOrder.filter(item => item !== couponId);
                    
                    saveToStorage();
                    renderAll();
                    showToast('ä¼˜æƒ åˆ¸å·²æ¢å¤åˆ°æœªä½¿ç”¨åˆ—è¡¨');
                });
            });

            // å›æ”¶ç«™å½»åº•åˆ é™¤æŒ‰é’®
            document.querySelectorAll('.recycle-list .remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const couponId = this.dataset.id;
                    if (!couponId || !recycleData[couponId]) {
                        showToast('æ— æ•ˆçš„ä¼˜æƒ åˆ¸ID');
                        return;
                    }
                    
                    currentDeleteId = couponId;
                    this.disabled = true;
                    deleteConfirmModal.style.display = 'flex';
                });
            });
        }

        // ========== å¼¹çª—äº‹ä»¶ ==========
        confirmCancelBtn.addEventListener('click', function() {
            deleteConfirmModal.style.display = 'none';
            if (currentDeleteId) {
                const btn = document.querySelector(`.recycle-list .remove-btn[data-id="${currentDeleteId}"]`);
                if (btn) btn.disabled = false;
            }
            currentDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', function() {
            deleteConfirmModal.style.display = 'none';
            if (!currentDeleteId || !recycleData[currentDeleteId]) {
                showToast('åˆ é™¤å¤±è´¥ï¼šæ— æ•ˆçš„ä¼˜æƒ åˆ¸ID');
                return;
            }

            const couponItem = document.querySelector(`.recycle-list .coupon-item[data-id="${currentDeleteId}"]`);
            if (couponItem) {
                couponItem.classList.add('deleting');
                
                setTimeout(() => {
                    delete recycleData[currentDeleteId];
                    recycleOrder = recycleOrder.filter(item => item !== currentDeleteId);
                    
                    saveToStorage();
                    renderAll();
                    showToast('ä¼˜æƒ åˆ¸å·²è¢«å½»åº•åˆ é™¤');
                    
                    currentDeleteId = null;
                }, 300);
            } else {
                delete recycleData[currentDeleteId];
                recycleOrder = recycleOrder.filter(item => item !== currentDeleteId);
                saveToStorage();
                renderAll();
                showToast('ä¼˜æƒ åˆ¸å·²è¢«å½»åº•åˆ é™¤');
                currentDeleteId = null;
            }
        });

        deleteConfirmModal.addEventListener('click', function(e) {
            if (e.target === deleteConfirmModal) {
                confirmCancelBtn.click();
            }
        });

        // æ–°å¢ä¼˜æƒ åˆ¸
        function saveAddCoupon() {
            const cat = document.getElementById('add-category').value.trim();
            const title = document.getElementById('add-title').value.trim();
            const expire = document.getElementById('add-expire').value.trim();
            const note = document.getElementById('add-note').value.trim();

            if(!cat || !title || !expire) { 
                showToast('åˆ†ç±»ã€æ ‡é¢˜ã€åˆ°æœŸæ—¶é—´ä¸èƒ½ä¸ºç©º'); 
                return; 
            }

            maxCouponId++;
            const couponId = maxCouponId.toString();
            couponData[couponId] = {
                category: cat, 
                title: title, 
                expire: expire, 
                note: note, 
                isUsed: false, 
                useTime: ''
            };
            couponOrder.push(couponId);

            saveToStorage();
            renderAll();
            addModal.style.display = 'none';
            showToast('ä¼˜æƒ åˆ¸æ·»åŠ æˆåŠŸ');
        }

        // ç¼–è¾‘ä¿å­˜
        function saveEditCoupon() {
            if(!currentEditId) return;
            const cat = document.getElementById('edit-category').value.trim();
            const title = document.getElementById('edit-title').value.trim();
            const expire = document.getElementById('edit-expire').value.trim();
            const note = document.getElementById('edit-note').value.trim();
            
            if(!cat || !title || !expire) { 
                showToast('åˆ†ç±»ã€æ ‡é¢˜ã€åˆ°æœŸæ—¶é—´ä¸èƒ½ä¸ºç©º'); 
                return; 
            }

            couponData[currentEditId].category = cat;
            couponData[currentEditId].title = title;
            couponData[currentEditId].expire = expire;
            couponData[currentEditId].note = note;

            saveToStorage();
            renderAll();
            editModal.style.display = 'none';
            currentEditId = null;
            showToast('ä¼˜æƒ åˆ¸ç¼–è¾‘æˆåŠŸ');
        }

        // ========== é€šç”¨äº‹ä»¶å¤„ç† ==========
        document.addEventListener('click', function(e) {
            // æœªä½¿ç”¨åˆ—è¡¨-åˆ é™¤æŒ‰é’®ï¼ˆç§»åˆ°å›æ”¶ç«™ï¼‰
            if (e.target.closest('.delete-btn') && !e.target.closest('.recycle-list')) {
                const couponId = e.target.closest('.delete-btn').dataset.id;
                const targetCoupon = { ...couponData[couponId] };
                targetCoupon.deleteTime = getCurrentTime();
                recycleData[couponId] = targetCoupon;
                
                if (!recycleOrder.includes(couponId)) {
                    recycleOrder.push(couponId);
                }
                
                delete couponData[couponId];
                couponOrder = couponOrder.filter(id => id !== couponId);
                
                saveToStorage();
                renderAll();
                showToast('ä¼˜æƒ åˆ¸å·²ç§»è‡³å›æ”¶ç«™');
                return;
            }

            // æœªä½¿ç”¨åˆ—è¡¨-ç¼–è¾‘æŒ‰é’®
            if (e.target.closest('.edit-btn')) {
                const couponId = e.target.closest('.edit-btn').dataset.id;
                currentEditId = couponId;
                const d = couponData[couponId];
                document.getElementById('edit-category').value = d.category;
                document.getElementById('edit-title').value = d.title;
                document.getElementById('edit-expire').value = d.expire;
                document.getElementById('edit-note').value = d.note;
                editModal.style.display = 'flex';
                return;
            }

            // æœªä½¿ç”¨åˆ—è¡¨-å¤é€‰æ¡†æ ‡è®°å·²ä½¿ç”¨
            if (e.target.closest('.coupon-checkbox')) {
                const couponId = e.target.closest('.coupon-item').dataset.id;
                couponData[couponId].isUsed = true;
                couponData[couponId].useTime = getCurrentTime();
                
                saveToStorage();
                renderAll();
                showToast('ä¼˜æƒ åˆ¸å·²æ ‡è®°ä¸ºå·²ä½¿ç”¨');
                return;
            }

            // å·²ä½¿ç”¨åˆ—è¡¨-æ¢å¤æŒ‰é’®
            if (e.target.closest('.used-list .restore-btn')) {
                const couponId = e.target.closest('.restore-btn').dataset.id;
                couponData[couponId].isUsed = false;
                couponData[couponId].useTime = '';
                
                saveToStorage();
                renderAll();
                showToast('ä¼˜æƒ åˆ¸å·²æ¢å¤ä¸ºæœªä½¿ç”¨');
                return;
            }
        });

        // æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.tab-item').forEach((tab, index)=>{
            tab.addEventListener('click', ()=>{
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                unusedList.style.display = index === 0 ? 'block' : 'none';
                usedList.style.display = index === 1 ? 'block' : 'none';
                recycleList.style.display = index === 2 ? 'block' : 'none';
            });
        });

        // å¼¹çª—äº‹ä»¶
        document.getElementById('cancel-add').addEventListener('click', ()=> addModal.style.display='none');
        document.getElementById('confirm-add').addEventListener('click', saveAddCoupon);
        document.getElementById('cancel-edit').addEventListener('click', ()=>{ 
            editModal.style.display='none'; 
            currentEditId=null; 
        });
        document.getElementById('confirm-edit').addEventListener('click', saveEditCoupon);

        // æ–°å¢æŒ‰é’®ç‚¹å‡»
        addCouponBtn.addEventListener('click', ()=>{
            document.getElementById('add-category').value = '';
            document.getElementById('add-title').value = '';
            document.getElementById('add-expire').value = '';
            document.getElementById('add-note').value = '';
            addModal.style.display = 'flex';
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
        addModal.addEventListener('click', e => {
            if (e.target === addModal) addModal.style.display = 'none';
        });
        editModal.addEventListener('click', e => {
            if (e.target === editModal) {
                editModal.style.display = 'none';
                currentEditId = null;
            }
        });

        // ========== åˆå§‹åŒ– ==========
        loadFromStorage();
        if (isLocalStorageAvailable()) {
            setTimeout(() => {
                showToast('ğŸ“± æœ¬åœ°å­˜å‚¨å·²å¯ç”¨ï¼Œæ•°æ®å¯æŒä¹…åŒ–');
            }, 1000);
        } else {
            setTimeout(() => {
                showToast('âš ï¸ è¯·æ£€æŸ¥APPå­˜å‚¨æƒé™', 3000);
            }, 1000);
        }
        renderAll();
    </script>
</body>
</html>